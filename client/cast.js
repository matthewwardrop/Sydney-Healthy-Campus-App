(function(window,undefined){var document=window.document,navigator=window.navigator,location=window.location;function Cast(varname,config_file){var that=this;this.varname=varname;this.STACKS={};this.CURRENT_STACK="default";this.EVENT_LISTENERS={};this.CONFIG.parent=this;if(config_file===undefined){alert("Config File not specified!");return}this.load_components([[config_file,"cast"],"iscroll"],function(data,textStatus,jqXHR){that.init()})}Cast.getInstance=function(varname,config_file){window[varname]=new Cast(varname,config_file);return window[varname]};Cast.prototype.wrap=function(func){var varname=this.varname;return function(){window[varname][func].apply(window[varname],arguments)}};Cast.prototype.MODULE_INITS=new Object();Cast.prototype.CONFIG=new Object();Cast.prototype.CONFIG.SERVER=null;Cast.prototype.CONFIG.SCRIPT=null;Cast.prototype.CONFIG.init=null;Cast.prototype.CONFIG.INIT_QUERY=null;Cast.prototype.CONFIG.LOCAL_METHODS={};Cast.prototype.init=function(){var that=this;for(var init_name in this.MODULE_INITS){this.MODULE_INITS[init_name].apply(this)}$(window).resize(function(){that.notifyEvent("resize")});$(document).ready(function(){that.notifyEvent("ready")});this.addEventListener(this.onInteractHandler,["onInteract"]);this.addEventListener(this.render,["render"]);window.addEventListener("hashchange",this.wrap("popStackTo"),false);this.CONFIG.init();this.loadSheet.apply(this,this.CONFIG.INIT_QUERY);this.notifyEvent("resize")};Cast.prototype.get_cast_uri=function(){var path=document.getElementById("cast").src;path=path.substring(0,Math.max(path.lastIndexOf("/"),path.lastIndexOf("\\\\")));return path};Cast.prototype.load_components=function(components,onLoaded){var completed=0;var aggregate=function(){completed++;if(completed==components.length){onLoaded(null,null,null)}};var makeLocal=function(data,status,jqXHR){eval(data.replace(/\$CAST/g,this.varname));aggregate()};for(var i in components){var url;var success=aggregate;var dataType="script";if($.isArray(components[i])){var file=components[i][0];var source=components[i][1];if(source=="cast"){url=file;dataType="text";success=makeLocal;url=file}else{url=this.get_cast_uri()+"/"+file+".js"}}else{url=this.get_cast_uri()+"/"+components[i]+".js"}$.ajax({url:url,context:this,dataType:dataType,success:success,error:function(jqXHR,textStatus,errorThrown){alert("Error loading '"+url+"' (url could be wrong): "+errorThrown)}})}};Cast.prototype.request=function(url,query,success,error){$.ajax({async:true,dataType:"jsonp",url:url,data:query,timeout:20000,success:success,error:error})};Cast.prototype.addToStack=function(sheetInfo,stack){if(stack==null){stack=this.CURRENT_STACK}if(this.STACKS[stack]==undefined){this.STACKS[stack]=[sheetInfo]}else{this.STACKS[stack].push(sheetInfo)}if(this.STACKS[stack].length>1){window.location.hash=this.STACKS[stack].length}};Cast.prototype.clearStack=function(stack){if(stack==null){stack=this.CURRENT_STACK}delete this.STACKS[stack]};Cast.prototype.popStack=function(stack,count){if(stack==null){stack=this.CURRENT_STACK}if(count==null){count=1}for(var i=0;i<count;i++){this.STACKS[stack].pop()}target=window.location.hash;if(target==""){target="#1"}if(this.STACKS[stack].length<target.replace("#","")){window.history.back(this.STACKS[stack].length-target.replace("#",""))}this.notifyEvent("render")};Cast.prototype.popStackTo=function(){stack=this.CURRENT_STACK;target=window.location.hash;if(target==""){target="#1"}this.popStack(stack,this.STACKS[stack].length-target.replace("#",""))};Cast.prototype.getCurrentStack=function(){return this.STACKS[this.CURRENT_STACK]};Cast.prototype.getCurrentSheet=function(){return this.STACKS[this.CURRENT_STACK][this.STACKS[this.CURRENT_STACK].length-1]};Cast.prototype.processText=function(text){var re=new RegExp("%\\(([a-zA-Z_]+):([^)]+)\\)s","g");var groups=re.exec(text);while(groups!=null){var value="undefined";if(groups[1] in this.CONFIG.LOCAL_METHODS){value=this.CONFIG.LOCAL_METHODS[groups[1]](this,groups[2])}text=text.replace(groups[0],value);groups=re.exec(text)}return text};Cast.prototype.addEventListener=function(listener,events){for(var i in events){var event=events[i];if(this.EVENT_LISTENERS[event]!=undefined){this.EVENT_LISTENERS[event][this.EVENT_LISTENERS[event].length]=listener}else{this.EVENT_LISTENERS[event]=[listener]}}};Cast.prototype.removeEventListener=function(listener,events){for(var i in events){delete this.EVENT_LISTENERS[events[i]][listener]}};Cast.prototype.notifyEvent=function(event){var args=Array.prototype.slice.call(arguments);info=args.slice(1);for(var i in this.EVENT_LISTENERS[event]){this.EVENT_LISTENERS[event][i].apply(this,info)}};function Action(cast,opts){}Action.prototype._run=null;Action.prototype.run=function(){this._run.apply(this,arguments)};Cast.prototype.getActionPrototype=function(){return Action};Cast.prototype.runAction=function(actionInfo){this.action(actionInfo).run()};var OpenSheet=function(cast,opts){this.cast=cast;this.opts=opts};OpenSheet.prototype=new Action();OpenSheet.prototype._run=function(){this.cast.clearStack();console.log(this.cast);this.cast.loadSheet(this.opts.type,this.opts.query,this.opts.stack)};var PushSheet=function(cast,opts){this.cast=cast;this.opts=opts};PushSheet.prototype=new Action();PushSheet.prototype._run=function(){this.cast.loadSheet(this.opts.type,this.opts.query,this.opts.stack)};var PopSheet=function(cast,opts){this.cast=cast;this.opts=opts};PopSheet.prototype=new Action();PopSheet.prototype._run=function(){this.cast.popStack(null,this.opts.count)};var PrefSave=function(cast,opts){this.cast=cast;this.opts=opts};PrefSave.prototype=new Action();PrefSave.prototype._run=function(){this.cast.preference(this.opts.key,this.opts.value)};var PrefSaveInput=function(cast,opts){this.cast=cast;this.opts=opts};PrefSaveInput.prototype=new Action();PrefSaveInput.prototype._run=function(domObject){this.cast.preference(this.opts.key,domObject.value)};var LocalMethod=function(cast,opts){this.cast=cast;this.opts=opts};LocalMethod.prototype=new Action();LocalMethod.prototype._run=function(){};Cast.prototype.action=function(actionInfo){SUPPORTED_ACTIONS={open:OpenSheet,push:PushSheet,pop:PopSheet,pref:PrefSave,pref_input:PrefSaveInput,method:LocalMethod};if(actionInfo instanceof Array){return new SUPPORTED_ACTIONS[actionInfo[0]](this,actionInfo[1])}else{if(typeof(actionInfo)=="string"){return new SUPPORTED_ACTIONS[actionInfo](this,null)}else{if(actionInfo instanceof Object){return new SUPPORTED_ACTIONS[actionInfo.action](this,actionInfo.opts)}else{alert("Unsupported action type: "+actionInfo)}}}};function View(cast,opts){}View.prototype._render=null;View.prototype.render=function(){if(!this._render instanceof Function){alert("Unimplemented: _render.");return}var obj=this._render.apply(this,arguments);if(isDOMElement(obj)){obj.setAttribute("class",this.opts["class"]==undefined?this.css_class:this.opts["class"]);if(this.opts.z_index!=undefined){$(obj).css("z-index",this.opts.z_index)}}if(isDOMElement(obj)&&this.opts.onclick!=undefined&&this.opts.onclick!=null){var onClickID=keys(this.cast.INTERACTION_HANDLERS).length+1;this.cast.INTERACTION_HANDLERS[onClickID]=this.getOnClick(this.opts.onclick);obj.setAttribute("onclick",this.cast.varname+".notifyEvent('onInteract',"+onClickID+",this);");$(obj).css("cursor","pointer")}if(isDOMElement(obj)&&(obj.tagName=="INPUT"||obj.tagName=="SELECT")&&this.opts.onchange!=undefined&&this.opts.onchange!=null){var onChangeID=keys(this.cast.INTERACTION_HANDLERS).length+1;this.cast.INTERACTION_HANDLERS[onChangeID]=this.getOnClick(this.opts.onchange);obj.setAttribute("onchange",this.cast.varname+".notifyEvent('onInteract',"+onChangeID+",this);")}if(this.opts.scroll!=undefined){var wrapper=document.createElement("div");wrapper.appendChild(obj);wrapper.setAttribute("class","wrapper");this.scroll_view=wrapper;return wrapper}return obj};View.prototype.getOnClick=function(detail){return this.cast.action(detail)};View.prototype.onReady=function(){var view=this.scroll_view;if(view!=undefined){$(view).height($(view).parent().height());var scroll=new iScroll(view,this.opts.scroll);if(this.opts.scroll.scrollMaxRight!=undefined){scroll.scrollTo($(view).find(">:first-child").innerWidth(),0,0,true)}}};View.prototype.css_class="view";function TextView(cast,opts){this.cast=cast;this.opts=opts}TextView.prototype=new View();TextView.prototype.css_class="textview";TextView.prototype._render=function(){var text=document.createElement("div");text.appendChild(document.createTextNode(this.cast.processText(this.opts)));return text};function TemplateView(cast,opts){this.cast=cast;this.opts=opts}TemplateView.prototype=new View();TemplateView.prototype.css_class="templateview";TemplateView.prototype._render=function(templates){var text=templates[this.opts.template];for(var field in this.opts.fields){text=this.cast.processText(text.replace(new RegExp("%\\("+field+"\\)s","g"),this.opts.fields[field]))}var div=document.createElement("div");div.innerHTML=text;return div};function ListView(cast,opts){this.cast=cast;this.opts=opts}ListView.prototype=new View();ListView.prototype.css_class="listview";ListView.prototype._render=function(){var ul=document.createElement("ul");for(var i in this.opts.list){var li=document.createElement("li");if(this.opts.templates!=undefined){li.appendChild(this.cast.getView(this.opts.list[i]).render(this.opts.templates))}else{li.appendChild(this.cast.getView(this.opts.list[i]).render())}ul.appendChild(li)}return ul};function ImageView(cast,opts){this.cast=cast;this.opts=opts}ImageView.prototype=new View();ImageView.prototype.css_class="imageview";ImageView.prototype._render=function(){var imgView=document.createElement("img");imgView.setAttribute("src",this.opts.src);return imgView};function IconView(cast,opts){this.cast=cast;this.opts=opts}IconView.prototype=new View();IconView.prototype.css_class="iconview";IconView.prototype._render=function(){var container=document.createElement("div");var labelSpan=document.createElement("span");labelSpan.appendChild(document.createTextNode(this.cast.processText(this.opts.label)));var icon=this.cast.getView(["image",{src:this.opts.icon}]).render();container.appendChild(icon);container.appendChild(labelSpan);return container};function ArrayView(cast,opts){this.cast=cast;this.opts=opts}ArrayView.prototype=new View();ArrayView.prototype.css_class="arrayview";ArrayView.prototype._render=function(){var array=this.opts.array;var container=document.createElement("div");for(var section in array){var sectionDiv=document.createElement("div");sectionDiv.setAttribute("class","sectiondiv");var sectionTitle=document.createElement("span");sectionTitle.setAttribute("class","sectiontitle");sectionTitle.innerHTML=this.cast.processText(section);sectionDiv.appendChild(sectionTitle);for(var i in array[section]){var viewInfo=array[section][i];var newView=this.cast.getView(viewInfo[0],viewInfo[1]);sectionDiv.appendChild(newView.render())}var spacer=document.createElement("span");spacer.setAttribute("class","spacer");sectionDiv.appendChild(spacer);container.appendChild(sectionDiv)}return container};function EditText(cast,opts){this.cast=cast;this.opts=opts}EditText.prototype=new View();EditText.prototype.css_class="edittext";EditText.prototype._render=function(){var editText=document.createElement("input");editText.value=this.cast.processText(this.opts.value);return editText};function EditSelect(cast,opts){this.cast=cast;this.opts=opts}EditSelect.prototype=new View();EditSelect.prototype.css_class="editselect";EditSelect.prototype._render=function(){var editSelect=document.createElement("select");var count=0;for(var option in this.opts.options){count++;editSelect.options[count]=new Option(option,this.opts.options[option],false,this.opts.options[option]==this.cast.processText(this.opts.selected))}return editSelect};function WebView(cast,opts){this.cast=cast;this.opts=opts}WebView.prototype=new View();WebView.prototype.css_class="webview";WebView.prototype._render=function(){var webDiv=document.createElement("div");webDiv.innerHTML=this.cast.processText(this.opts.html);return webDiv};function StackView(cast,opts){this.cast=cast;this.opts=opts}StackView.prototype=new View();StackView.prototype.css_class="stackview";StackView.prototype._render=function(){var stackList=[];var currentStack=this.cast.getCurrentStack();for(var i in currentStack){var classname="";if(i==currentStack.length-1){classname="active"}stackList.push(["template",{z_index:currentStack.length-i,li_class:classname,"class":classname,onclick:["pop",{count:currentStack.length-i-1}],template:"titles",fields:{title:currentStack[i].title}}])}return this.cast.getView(["list",{"class":"stackview",list:stackList,scroll:{vScroll:false,hScrollbar:false,scrollMaxRight:true},templates:{titles:"<span>%(title)s</span>"}}]).render()};Cast.prototype.getViewPrototype=function(){return View};Cast.prototype.getView=function(viewInfo){SUPPORTED_VIEWS={text:TextView,list:ListView,icon:IconView,image:ImageView,array:ArrayView,template:TemplateView,webview:WebView,stack:StackView,edit:EditText,select:EditSelect};var view;if(viewInfo instanceof Array){view=new SUPPORTED_VIEWS[viewInfo[0]](this,viewInfo[1])}else{if(typeof(viewInfo)=="string"){view=new SUPPORTED_VIEWS.text(this,viewInfo)}else{if(viewInfo instanceof Object){view=new SUPPORTED_VIEWS[viewInfo.view](this,viewInfo)}else{alert("Unsupported view type!.");return}}}this.CURRENT_VIEWS.push(view);return view};Cast.prototype.CONFIG.DEFAULT_FACTORY=null;Cast.prototype.CONFIG.FACTORIES={};Cast.prototype.getSheet=function(type,opts,success,error){function UrlFactory(cast){var url=opts.url;if(url==undefined||url==null){url=cast.CONFIG.SERVER+cast.CONFIG.SCRIPT}var query=opts.query;if(query==null||query==undefined){query=opts}return cast.request(url,query,success,error)}function ScriptFactory(cast){var factory=opts.factory;if(factory==undefined||factory==null){factory=cast.CONFIG.DEFAULT_FACTORY}factory=cast.CONFIG.FACTORIES[factory];if(factory==undefined||factory==null){alert("no such factory "+opts.factory)}try{success(factory(opts))}catch(e){alert("Cannot run factory: "+e)}}SUPPORTED_FACTORIES={url:UrlFactory,script:ScriptFactory};if(type==null){type="url"}SUPPORTED_FACTORIES[type](this)};Cast.prototype.CONFIG.DEFAULT_DISPLAY={};Cast.prototype.CONFIG.RENDER_HANDLERS={};Cast.prototype.CURRENT_VIEWS=[];Cast.prototype.INTERACTION_HANDLERS={};Cast.prototype.MODULE_INITS.render=function(){this.addEventListener(function(){for(var i=0;i<this.CURRENT_VIEWS.length;i++){this.CURRENT_VIEWS[i].onReady()}},["render_complete"])};Cast.prototype.loadSheet=function(type,opts,stack){var that=this;function success(data,a,b){that.renderSheet(data,stack)}function error(jqXHR,textStatus,errorThrown){alert("cannot load sheet"+errorThrown)}this.notifyEvent("loading","start");this.getSheet(type,opts,success,error)};Cast.prototype.processInfo=function(sheetInfo){for(field in this.CONFIG.DEFAULT_DISPLAY){if(!(field in sheetInfo)){sheetInfo[field]=this.CONFIG.DEFAULT_DISPLAY[field]}}return sheetInfo};Cast.prototype.defaultRenderHandler=function(element,data){try{$(element).empty();$(element).append(this.getView(data).render())}catch(err){alert(err)}};Cast.prototype.getCSSList=function(){var css=[];$("head > link[rel='stylesheet']").each(function(i){css[css.length]=$(this).attr("href")});return css};Cast.prototype.castDirectiveHandler=function(field,info){if(field=="cast_css_add"){$(info).each(function(){if($.inArray(this,this.getCSSList())==-1){$("head").append("<link>");css=$("head").children(":last");css.attr({rel:"stylesheet",type:"text/css",href:this})}})}else{if(field=="cast_css_remove"){$(info).each(function(){if($.inArray(this,this.getCSSList())>-1){$("head > link[href='"+this+"']").remove()}})}}};Cast.prototype.renderSheet=function(sheetInfo,stack){this.addToStack(sheetInfo,stack);this.notifyEvent("render")};Cast.prototype.render=function(){this.CURRENT_VIEWS=[];this.INTERACTION_HANDLERS={};sheetInfo=this.getCurrentSheet();sheetInfo=this.processInfo(sheetInfo);order=[];if("cast_order" in sheetInfo){order=sheetInfo.cast_order;delete sheetInfo.cast_order;for(var key in sheetInfo){if(!(key in order)){order[order.length]=key}}}else{order=keys(sheetInfo)}for(field in sheetInfo){if(field.startsWith("cast_")){this.castDirectiveHandler(field,sheetInfo[field]);continue}if(field in this.CONFIG.RENDER_HANDLERS){var handler=this.CONFIG.RENDER_HANDLERS[field];if(handler instanceof Function){this.CONFIG.RENDER_HANDLERS[field](this,sheetInfo[field])}else{if(isDOMElement(handler)){this.defaultRenderHandler(handler,sheetInfo[field])}else{if(typeof handler=="string"){element=document.getElementById(handler);if(element!=null){this.defaultRenderHandler(element,sheetInfo[field])}}}}}}this.notifyEvent("render_complete");this.notifyEvent("loading","end")};Cast.prototype.onInteractHandler=function(id,domObject){var handler=this.INTERACTION_HANDLERS[id];if(handler!=null){handler.run(domObject)}};Cast.prototype.preference=function(key,value){if(value==null){return window.localStorage.getItem(key)}return window.localStorage.setItem(key,value)};function isDOMNode(o){return(typeof Node==="object"?o instanceof Node:o&&typeof o==="object"&&typeof o.nodeType==="number"&&typeof o.nodeName==="string")}function isDOMElement(o){return(typeof HTMLElement==="object"?o instanceof HTMLElement:o&&typeof o==="object"&&o.nodeType===1&&typeof o.nodeName==="string")}if(typeof String.prototype.startsWith!="function"){String.prototype.startsWith=function(str){return this.indexOf(str)==0}}function keys(o){var keys=[];for(var key in o){keys.push(key)}return keys}if(!window.console){console={}}console.log=console.log||function(){};console.warn=console.warn||function(){};console.error=console.error||function(){};console.info=console.info||function(){};window.Cast=Cast})(window);